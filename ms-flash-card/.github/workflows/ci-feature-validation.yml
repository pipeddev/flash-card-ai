name: CI - Validation

on:
  pull_request:
    branches:
      - develop
      - main
    types: [opened, synchronize, reopened]

jobs:
  quality-check:
    name: ğŸ” Validate Lint & Tests
    runs-on: ubuntu-latest

    # âœ… Solo ejecutar si la rama de origen es feature/*, bugfix/* o hotfix/*
    if: |
      startsWith(github.head_ref, 'feature/') ||
      startsWith(github.head_ref, 'bugfix/') ||
      startsWith(github.head_ref, 'hotfix/')

    steps:
      - name: ğŸ§© Checkout repository
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: ğŸ“¦ Install pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9
          run_install: false

      - name: ğŸ” Check lockfile presence
        run: |
          if [ ! -f "pnpm-lock.yaml" ]; then
            echo "âŒ pnpm-lock.yaml not found!"
            exit 1
          fi
          echo "âœ… pnpm-lock.yaml found."

      - name: ğŸ“¦ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ§¹ Run ESLint
        run: pnpm lint

      - name: ğŸ§ª Run Jest Tests with Coverage
        run: pnpm test:cov

      - name: ğŸ“Š Enforce Minimum Coverage
        run: |
          THRESHOLD=80
          echo "â–¶ï¸ Running coverage check with threshold $THRESHOLD%"

          COVERAGE=$(cat coverage/coverage-summary.json | jq '.total.lines.pct')
          echo "ğŸ“Š Cobertura actual: ${COVERAGE}%"

          if (( $(echo "$COVERAGE < $THRESHOLD" | bc -l) )); then
            echo "âŒ Error: La cobertura es ${COVERAGE}%, se requiere al menos ${THRESHOLD}%"
            exit 1
          else
            echo "âœ… Cobertura aprobada: ${COVERAGE}%"
          fi

  # ğŸš« Mensaje claro cuando la rama no cumple la convenciÃ³n
  skipped:
    name: ğŸš« Skip Non-Validated Branches
    runs-on: ubuntu-latest
    if: |
      !(
        startsWith(github.head_ref, 'feature/') ||
        startsWith(github.head_ref, 'bugfix/') ||
        startsWith(github.head_ref, 'hotfix/')
      )
    steps:
      - name: â„¹ï¸ Skipped message
        run: |
          echo "ğŸš« CI omitido â€” rama '${{ github.head_ref }}' no pertenece a feature/*, bugfix/* ni hotfix/*."
          echo "â„¹ï¸ Este flujo solo valida ramas de desarrollo oficiales."
